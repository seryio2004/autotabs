<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>PDF + MP3 sincronizados (saltos simples)</title>

  <!-- Favicon vacío para evitar 404 -->
  <link rel="icon" href="data:,">

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
  </script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f5f5f5;
    }
    h1 {
      margin-top: 0;
    }
    .panel {
      background: white;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.08);
    }
    label {
      display: block;
      margin-top: 0.5rem;
      font-weight: 600;
    }
    #status {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: #555;
    }
    #viewer {
      display: flex;
      gap: 1rem;
      align-items: flex-start;
      justify-content: center;
      flex-wrap: wrap;
    }
    canvas {
      border: 1px solid #ccc;
      background: white;
      max-width: 100%;
    }
    .page-label {
      text-align: center;
      font-size: 0.8rem;
      margin-bottom: 0.25rem;
      color: #666;
    }
    #manual-panel {
      margin-top: 0.75rem;
      padding: 0.5rem;
      border-radius: 6px;
      background: #fafafa;
      border: 1px solid #e0e0e0;
      font-size: 0.85rem;
    }
    #manual-controls .row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.35rem;
    }
    #manual-controls label {
      margin: 0;
      font-weight: 500;
      min-width: 150px;
    }
    #manual-controls input[type="number"] {
      width: 90px;
      padding: 0.2rem 0.3rem;
      font-size: 0.85rem;
    }
    #apply-btn {
      margin-top: 0.5rem;
      padding: 0.3rem 0.8rem;
      font-size: 0.85rem;
      cursor: pointer;
    }
    #hint {
      font-size: 0.8rem;
      color: #666;
      margin-top: 0.25rem;
    }
  </style>
</head>
<body>

  <h1>PDF + MP3 sincronizados (saltos de página)</h1>

  <div class="panel">
    <label>Subir PDF de la tablatura / partitura:</label>
    <input type="file" id="pdf-file" accept="application/pdf" />

    <label>Subir archivo MP3 de la canción:</label>
    <input type="file" id="audio-file" accept="audio/mp3, audio/mpeg" />

    <button id="load-btn">Cargar PDF y MP3</button>

    <div id="manual-panel">
      <p style="margin:0 0 0.5rem;">
        Se crean automáticamente unos <b>saltos de página aproximados</b> a partir de la duración
        real del MP3. Cada salto mueve la página derecha a la izquierda y carga la siguiente.
        Puedes ajustar cada tiempo (en segundos) y pulsar <b>“Aplicar cambios”</b>.
      </p>
      <div id="manual-controls">
        <!-- Aquí aparecerán los saltos: Salto 1, Salto 2, ... -->
      </div>
      <button id="apply-btn">Aplicar cambios</button>
      <div id="hint">
        Truco: reproduce la canción, mira en qué segundo debería cambiar de páginas (por ejemplo,
        pasar de 1–2 a 2–3) y ajusta el valor del salto correspondiente para que coincida.
      </div>
    </div>

    <div id="status">Esperando archivos…</div>
  </div>

  <div class="panel">
    <audio id="player" controls></audio>
  </div>

  <div class="panel" id="viewer">
    <div>
      <div class="page-label" id="left-label"></div>
      <canvas id="pdf-left"></canvas>
    </div>
    <div>
      <div class="page-label" id="right-label"></div>
      <canvas id="pdf-right"></canvas>
    </div>
  </div>

<script>
  // ========= VARIABLES GLOBALES =========
  let pdfDoc = null;
  let pdfLoaded = false;
  let audioMetaLoaded = false;
  let audioDuration = 0;

  // Páginas visibles
  let leftPage = 1;
  let rightPage = 2;

  // Tiempos de SALTO de página (en segundos).
  // pageTurnTimes[i] = segundo del MP3 en el que se produce el salto i+1:
  //   - Antes de salto 1 -> se ve (1,2)
  //   - Entre salto 1 y salto 2 -> se ve (2,3)
  //   - Entre salto 2 y salto 3 -> se ve (3,4)
  //   - etc.
  let pageTurnTimes = [];

  // Referencias al DOM
  const leftCanvas = document.getElementById('pdf-left');
  const rightCanvas = document.getElementById('pdf-right');
  const leftCtx = leftCanvas.getContext('2d');
  const rightCtx = rightCanvas.getContext('2d');

  const leftLabel = document.getElementById('left-label');
  const rightLabel = document.getElementById('right-label');

  const statusEl = document.getElementById('status');
  const audio = document.getElementById('player');

  const manualControls = document.getElementById('manual-controls');
  const applyBtn = document.getElementById('apply-btn');

  // ========= CÁLCULO AUTOMÁTICO INICIAL DE pageTurnTimes =========
  function initPageTurnTimes() {
    if (!pdfDoc || !audioMetaLoaded) {
      renderManualControls();
      return;
    }

    const totalPages = pdfDoc.numPages;

    // Con 1 o 2 páginas no tiene sentido hacer saltos:
    //   - 1 página: siempre la misma.
    //   - 2 páginas: siempre (1,2).
    if (totalPages <= 2 || audioDuration <= 0) {
      pageTurnTimes = [];
      renderManualControls();
      return;
    }

    // Número de saltos posibles:
    //   Páginas: 1,2,3,4,...,N
    //   Vistas: (1,2) -> (2,3) -> ... -> (N-1, N)
    //   Número de vistas = N-1  => número de saltos = (N-1) - 1 = N-2
    const numTurns = totalPages - 2;

    pageTurnTimes = new Array(numTurns);

    // Repartimos la duración en (numTurns + 1) tramos y usamos los puntos intermedios
    const step = audioDuration / (numTurns + 1);
    for (let i = 0; i < numTurns; i++) {
      pageTurnTimes[i] = step * (i + 1);
    }

    renderManualControls();
  }

  // ========= UI PARA EDITAR pageTurnTimes =========
  function renderManualControls() {
    manualControls.innerHTML = '';

    if (!pdfDoc) {
      const note = document.createElement('div');
      note.textContent = 'Carga un PDF y un MP3 para ver y editar los saltos de página.';
      manualControls.appendChild(note);
      return;
    }

    const totalPages = pdfDoc.numPages;

    if (totalPages <= 2) {
      const note = document.createElement('div');
      note.textContent = 'El PDF tiene solo 1 o 2 páginas; no hay saltos de página automáticos.';
      manualControls.appendChild(note);
      return;
    }

    if (!audioMetaLoaded || audioDuration <= 0) {
      const note = document.createElement('div');
      note.textContent = 'Esperando a que se cargue el MP3 para calcular saltos aproximados.';
      manualControls.appendChild(note);
      return;
    }

    if (!pageTurnTimes || pageTurnTimes.length === 0) {
      const note = document.createElement('div');
      note.textContent = 'No hay saltos definidos. Revisa que el MP3 tenga duración válida.';
      manualControls.appendChild(note);
      return;
    }

    const numTurns = pageTurnTimes.length;

    for (let i = 0; i < numTurns; i++) {
      const saltoIndex = i + 1;
      const leftAfter = 1 + saltoIndex;          // página izquierda después de ese salto
      const rightAfter = Math.min(totalPages, leftAfter + 1);

      const row = document.createElement('div');
      row.className = 'row';

      const label = document.createElement('label');
      label.textContent = `Salto ${saltoIndex} (ver páginas ${leftAfter}–${rightAfter}):`;

      const input = document.createElement('input');
      input.type = 'number';
      input.step = '0.1';
      input.dataset.index = String(i);
      input.value = pageTurnTimes[i].toFixed(2);

      const span = document.createElement('span');
      span.textContent = 'seg';

      row.appendChild(label);
      row.appendChild(input);
      row.appendChild(span);
      manualControls.appendChild(row);
    }
  }

  // ========= CARGA DE PDF =========
  function loadPDF(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const typedarray = new Uint8Array(e.target.result);
      pdfjsLib.getDocument(typedarray).promise.then(function(doc) {
        pdfDoc = doc;
        pdfLoaded = true;

        const totalPages = pdfDoc.numPages;

        leftPage = 1;
        rightPage = Math.min(2, totalPages);

        renderDoublePage();

        // En cuanto tengamos duración del audio, se calculan los saltos
        initPageTurnTimes();

        statusEl.textContent = `PDF cargado: ${totalPages} páginas. Ajusta los saltos si quieres y pulsa "Aplicar cambios".`;
      }).catch(err => {
        console.error(err);
        statusEl.textContent = 'Error al cargar el PDF.';
      });
    };
    reader.readAsArrayBuffer(file);
  }

  function renderPage(pageNumber, canvas, ctx) {
    if (!pdfDoc || pageNumber < 1 || pageNumber > pdfDoc.numPages) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      canvas.width = 0;
      canvas.height = 0;
      return;
    }

    pdfDoc.getPage(pageNumber).then(function(page) {
      const viewport = page.getViewport({ scale: 1.4 });
      canvas.height = viewport.height;
      canvas.width = viewport.width;

      const renderContext = {
        canvasContext: ctx,
        viewport: viewport
      };
      page.render(renderContext);
    });
  }

  function renderDoublePage() {
    renderPage(leftPage, leftCanvas, leftCtx);
    renderPage(rightPage, rightCanvas, rightCtx);

    if (pdfDoc) {
      leftLabel.textContent = `Página ${leftPage}`;
      rightLabel.textContent = (rightPage <= pdfDoc.numPages) ? `Página ${rightPage}` : '';
    } else {
      leftLabel.textContent = '';
      rightLabel.textContent = '';
    }
  }

  // ========= ACTUALIZAR PÁGINAS SEGÚN TIEMPO DEL AUDIO =========
  function updatePagesForCurrentTime() {
    if (!pdfDoc || !pdfLoaded || !pageTurnTimes || pageTurnTimes.length === 0) {
      return;
    }

    const totalPages = pdfDoc.numPages;
    if (totalPages <= 2) {
      return; // no hay saltos que hacer
    }

    const t = audio.currentTime;

    // Contamos cuántos saltos han ocurrido ya (t >= tiempo del salto)
    let turnsDone = 0;
    for (let i = 0; i < pageTurnTimes.length; i++) {
      if (t >= pageTurnTimes[i]) {
        turnsDone++;
      } else {
        break; // están en orden creciente
      }
    }

    // leftPage = 1 + turnsDone, limitado a [1, totalPages-1]
    let newLeft = 1 + turnsDone;
    if (newLeft > totalPages - 1) {
      newLeft = totalPages - 1;
    }
    if (newLeft < 1) newLeft = 1;

    let newRight = (newLeft + 1 <= totalPages) ? newLeft + 1 : totalPages;

    if (newLeft !== leftPage || newRight !== rightPage) {
      leftPage = newLeft;
      rightPage = newRight;
      renderDoublePage();
    }

    statusEl.textContent =
      `t=${t.toFixed(1)}s | Saltos hechos: ${turnsDone} | Viendo páginas: ${leftPage}-${rightPage}`;
  }

  // ========= EVENTOS DEL AUDIO =========
  audio.addEventListener('loadedmetadata', () => {
    audioMetaLoaded = true;
    audioDuration = audio.duration || 0;

    if (audioDuration <= 0) {
      statusEl.textContent = 'El MP3 parece no tener duración válida.';
    }

    // Si el PDF ya está cargado, calculamos saltos
    if (pdfDoc) {
      initPageTurnTimes();
    }
  });

  audio.addEventListener('timeupdate', () => {
    updatePagesForCurrentTime();
  });

  // ========= APLICAR CAMBIOS MANUALES =========
  applyBtn.addEventListener('click', () => {
    if (!pdfDoc || !pageTurnTimes || pageTurnTimes.length === 0) return;

    const totalPages = pdfDoc.numPages;
    if (totalPages <= 2) return;

    const inputs = manualControls.querySelectorAll('input[type="number"]');
    const newTimes = [];

    inputs.forEach(input => {
      const idx = parseInt(input.dataset.index, 10);
      let val = parseFloat(String(input.value).replace(',', '.'));
      if (!isNaN(idx) && !isNaN(val)) {
        val = Math.max(0, val);
        newTimes[idx] = val;
      }
    });

    // Rellenar huecos que no hayan sido escritos correctamente con el valor anterior
    for (let i = 0; i < pageTurnTimes.length; i++) {
      if (typeof newTimes[i] !== 'number') {
        newTimes[i] = pageTurnTimes[i];
      }
    }

    // Ordenamos de menor a mayor para asegurar que los saltos son cronológicos
    newTimes.sort((a, b) => a - b);
    pageTurnTimes = newTimes;

    statusEl.textContent =
      'Cambios manuales aplicados. Cada vez que el MP3 pase por uno de esos segundos se avanzará un salto de páginas.';
  });

  // ========= BOTÓN CARGAR =========
  document.getElementById('load-btn').addEventListener('click', () => {
    const pdfFile = document.getElementById('pdf-file').files[0];
    const audioFile = document.getElementById('audio-file').files[0];

    if (!pdfFile) {
      alert('Sube un archivo PDF.');
      return;
    }
    if (!audioFile) {
      alert('Sube un archivo MP3.');
      return;
    }

    statusEl.textContent = 'Cargando archivos…';

    // Cargamos PDF
    loadPDF(pdfFile);

    // Cargamos audio
    const audioURL = URL.createObjectURL(audioFile);
    audio.src = audioURL;
    audio.load();

    statusEl.textContent =
      'Archivos cargados. Se calcularán saltos aproximados y podrás ajustarlos antes o durante la reproducción.';
  });
</script>

</body>
</html>
