<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>PDF + MP3 sincronizados (doble página, auto/manual)</title>

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 1rem;
      background: #f5f5f5;
    }
    h1 {
      margin-top: 0;
    }
    .panel {
      background: white;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.08);
    }
    label {
      display: block;
      margin-top: 0.5rem;
      font-weight: 600;
    }
    #status {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: #555;
    }
    #viewer {
      display: flex;
      gap: 1rem;
      align-items: flex-start;
      justify-content: center;
      flex-wrap: wrap;
    }
    canvas {
      border: 1px solid #ccc;
      background: white;
      max-width: 100%;
    }
    .page-label {
      text-align: center;
      font-size: 0.8rem;
      margin-bottom: 0.25rem;
      color: #666;
    }
    .mode-options {
      margin-top: 0.75rem;
      font-size: 0.9rem;
    }
    .mode-options label {
      font-weight: 400;
      display: inline-block;
      margin-right: 1rem;
    }
    #manual-panel {
      margin-top: 0.75rem;
      padding: 0.5rem;
      border-radius: 6px;
      background: #fafafa;
      border: 1px solid #e0e0e0;
    }
    .manual-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.35rem;
      font-size: 0.85rem;
    }
    .manual-row input[type="number"] {
      width: 80px;
      padding: 0.15rem 0.3rem;
      font-size: 0.85rem;
    }
    .manual-row button {
      font-size: 0.8rem;
      padding: 0.15rem 0.4rem;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h1>PDF + MP3 sincronizados (doble página, auto/manual)</h1>

  <div class="panel">
    <label>Subir PDF de la tablatura / partitura:</label>
    <input type="file" id="pdf-file" accept="application/pdf" />

    <label>Subir archivo MP3 de la canción:</label>
    <input type="file" id="audio-file" accept="audio/mp3, audio/mpeg" />

    <button id="load-btn">Cargar PDF y MP3</button>

    <div class="mode-options">
      <span>Modo de cambios:</span>
      <label><input type="radio" name="mode" id="mode-auto" checked> Automático (BPM/compases)</label>
      <label><input type="radio" name="mode" id="mode-manual"> Manual (ajustar segundos)</label>
    </div>

    <div id="manual-panel" style="display:none;">
      <p style="font-size:0.85rem;color:#555;margin-top:0;">
        Basado en el cálculo automático. Ajusta los segundos de cambio, o pulsa
        <b>“Usar tiempo actual”</b> mientras suena el audio para afinar a oído.
      </p>
      <div id="manual-controls"></div>
    </div>

    <div id="status">Esperando archivos…</div>
  </div>

  <div class="panel">
    <audio id="player" controls></audio>
  </div>

  <div class="panel" id="viewer">
    <div>
      <div class="page-label" id="left-label"></div>
      <canvas id="pdf-left"></canvas>
    </div>
    <div>
      <div class="page-label" id="right-label"></div>
      <canvas id="pdf-right"></canvas>
    </div>
  </div>

<script>
  // ========= CONFIGURACIÓN MUSICAL (base automática) =========
  const songStructure = {
    bpm: 120,             // Ajusta al BPM real de la canción
    beatsPerBar: 4,       // 4/4 normalmente
    offsetSeconds: 0,     // Si la tab empieza más tarde que el audio, pon el retraso aquí
    extraLateDelaySeconds: 2.0, // Retraso global: cambia SIEMPRE tarde

    // Para cada página: compases que abarca
    pageByBars: [
      { fromBar: 1,  toBar: 8,  page: 1 },
      { fromBar: 9,  toBar: 16, page: 2 },
      { fromBar: 17, toBar: 24, page: 3 },
      { fromBar: 25, toBar: 32, page: 4 }
      // Añade más si tu PDF tiene más páginas
    ]
  };

  // ========= VARIABLES GLOBALES =========
  let pdfDoc = null;
  let pdfLoaded = false;

  let leftPage = 1;
  let rightPage = 2;
  let logicalPage = 1;       // página "activa" según el tiempo

  let pageSegments = [];     // datos automáticos por página (start/end/change)
  let autoChangePoints = []; // {page, changeTime} calculado automáticamente
  let manualChangePoints = []; // copia editable para modo manual

  let mode = 'auto';

  const leftCanvas = document.getElementById('pdf-left');
  const rightCanvas = document.getElementById('pdf-right');
  const leftCtx = leftCanvas.getContext('2d');
  const rightCtx = rightCanvas.getContext('2d');

  const leftLabel = document.getElementById('left-label');
  const rightLabel = document.getElementById('right-label');

  const statusEl = document.getElementById('status');
  const audio = document.getElementById('player');
  const manualPanel = document.getElementById('manual-panel');
  const manualControls = document.getElementById('manual-controls');

  const modeAutoRadio = document.getElementById('mode-auto');
  const modeManualRadio = document.getElementById('mode-manual');

  // ========= PRE-CÁLCULOS AUTOMÁTICOS =========
  function buildPageSegments() {
    const {
      bpm,
      beatsPerBar,
      offsetSeconds,
      extraLateDelaySeconds,
      pageByBars
    } = songStructure;

    pageSegments = pageByBars.map(seg => {
      const startBeats = (seg.fromBar - 1) * beatsPerBar;
      const endBeats   = seg.toBar * beatsPerBar;

      const startTime = offsetSeconds + (startBeats / bpm) * 60;
      const endTime   = offsetSeconds + (endBeats   / bpm) * 60;

      const changeTime = endTime + extraLateDelaySeconds;

      return {
        page: seg.page,
        startTime,
        endTime,
        changeTime
      };
    });

    // A partir de los segmentos, generamos puntos de cambio:
    // "en el segundo X, cambiamos a la página Y".
    autoChangePoints = [];
    for (let i = 1; i < pageSegments.length; i++) {
      autoChangePoints.push({
        page: pageSegments[i].page,
        changeTime: pageSegments[i].changeTime
      });
    }
  }

  function initManualFromAuto() {
    // Partimos de la base automática
    manualChangePoints = autoChangePoints.map(cp => ({
      page: cp.page,
      changeTime: cp.changeTime
    }));
    renderManualControls();
  }

  function renderManualControls() {
    manualControls.innerHTML = '';
    if (!manualChangePoints.length) {
      manualControls.textContent = 'No hay cambios de página definidos.';
      return;
    }

    manualChangePoints.forEach((cp, idx) => {
      const row = document.createElement('div');
      row.className = 'manual-row';

      const label = document.createElement('span');
      label.textContent = `Cambio a página ${cp.page} en`;

      const input = document.createElement('input');
      input.type = 'number';
      input.step = '0.1';
      input.value = cp.changeTime.toFixed(2);
      input.addEventListener('change', () => {
        const val = parseFloat(input.value.replace(',', '.'));
        cp.changeTime = isNaN(val) ? cp.changeTime : Math.max(0, val);
      });

      const spanSeg = document.createElement('span');
      spanSeg.textContent = 'seg';

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = 'Usar tiempo actual';
      btn.addEventListener('click', () => {
        if (!audio.duration || isNaN(audio.currentTime)) {
          alert('Reproduce el audio para poder fijar el tiempo actual.');
          return;
        }
        cp.changeTime = audio.currentTime;
        input.value = cp.changeTime.toFixed(2);
      });

      row.appendChild(label);
      row.appendChild(input);
      row.appendChild(spanSeg);
      row.appendChild(btn);
      manualControls.appendChild(row);
    });
  }

  buildPageSegments();
  initManualFromAuto();

  // ========= CARGA DE PDF =========
  function loadPDF(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const typedarray = new Uint8Array(e.target.result);
      pdfjsLib.getDocument(typedarray).promise.then(function(doc) {
        pdfDoc = doc;
        pdfLoaded = true;

        const firstPage = songStructure.pageByBars[0]?.page || 1;
        logicalPage = firstPage;
        leftPage = logicalPage;
        rightPage = Math.min(logicalPage + 1, pdfDoc.numPages);

        renderDoublePage();
        statusEl.textContent = `PDF cargado: ${pdfDoc.numPages} páginas.`;
      }).catch(err => {
        console.error(err);
        statusEl.textContent = 'Error al cargar el PDF.';
      });
    };
    reader.readAsArrayBuffer(file);
  }

  function renderPage(pageNumber, canvas, ctx) {
    if (!pdfDoc || pageNumber < 1 || pageNumber > pdfDoc.numPages) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      return;
    }

    pdfDoc.getPage(pageNumber).then(function(page) {
      const viewport = page.getViewport({ scale: 1.4 });
      canvas.height = viewport.height;
      canvas.width = viewport.width;

      const renderContext = {
        canvasContext: ctx,
        viewport: viewport
      };
      page.render(renderContext);
    });
  }

  function renderDoublePage() {
    renderPage(leftPage, leftCanvas, leftCtx);
    renderPage(rightPage, rightCanvas, rightCtx);

    leftLabel.textContent = pdfDoc ? `Página ${leftPage}` : '';
    rightLabel.textContent = (pdfDoc && rightPage <= pdfDoc.numPages)
      ? `Página ${rightPage}`
      : '';
  }

  // ========= LÓGICA DE PÁGINA SEGÚN TIEMPO =========
  function getLogicalPageForTime(time) {
    const firstPage = songStructure.pageByBars[0]?.page || 1;
    const points = (mode === 'manual') ? manualChangePoints : autoChangePoints;

    let page = firstPage;

    // Nunca cambia antes: sólo cuando el tiempo supera el changeTime
    for (const cp of points) {
      if (time >= cp.changeTime) {
        page = cp.page;
      } else {
        break;
      }
    }

    return page;
  }

  function updateViewerToLogicalPage() {
    if (!pdfDoc) return;

    // Si ya se ve en la izquierda o la derecha, no movemos nada
    if (logicalPage === leftPage || logicalPage === rightPage) {
      return;
    }

    // Queremos que la "ventana" de 2 páginas vaya avanzando
    // de forma contigua: (1-2), luego (2-3), luego (3-4)...
    while (logicalPage > rightPage && rightPage < pdfDoc.numPages) {
      leftPage = rightPage;
      rightPage = Math.min(pdfDoc.numPages, rightPage + 1);
    }

    // Si vamos hacia atrás (has rebobinado)
    while (logicalPage < leftPage && leftPage > 1) {
      rightPage = leftPage;
      leftPage = Math.max(1, leftPage - 1);
    }

    renderDoublePage();
  }

  // ========= SINCRONIZACIÓN CON EL AUDIO =========
  audio.addEventListener('timeupdate', () => {
    if (!pdfLoaded) return;

    const t = audio.currentTime;
    const newLogical = getLogicalPageForTime(t);

    if (newLogical !== logicalPage) {
      logicalPage = newLogical;
      updateViewerToLogicalPage();
    }

    statusEl.textContent =
      `t=${t.toFixed(1)}s | Página lógica: ${logicalPage} | Viendo: ${leftPage}-${rightPage} | Modo: ${mode}`;
  });

  // ========= CAMBIO DE MODO AUTO / MANUAL =========
  modeAutoRadio.addEventListener('change', () => {
    if (modeAutoRadio.checked) {
      mode = 'auto';
      manualPanel.style.display = 'none';
    }
  });

  modeManualRadio.addEventListener('change', () => {
    if (modeManualRadio.checked) {
      mode = 'manual';
      manualPanel.style.display = 'block';
      // Por si has cambiado la estructura automática, re-asegura bases:
      if (!manualChangePoints.length) {
        initManualFromAuto();
      }
    }
  });

  // ========= BOTÓN CARGAR =========
  document.getElementById('load-btn').addEventListener('click', () => {
    const pdfFile = document.getElementById('pdf-file').files[0];
    const audioFile = document.getElementById('audio-file').files[0];

    if (!pdfFile) {
      alert('Sube un archivo PDF.');
      return;
    }
    if (!audioFile) {
      alert('Sube un archivo MP3.');
      return;
    }

    statusEl.textContent = 'Cargando archivos…';

    loadPDF(pdfFile);

    const audioURL = URL.createObjectURL(audioFile);
    audio.src = audioURL;
    audio.load();

    statusEl.textContent =
      'Archivos cargados. El modo automático ya calcula los cambios; puedes afinar en el modo manual.';
  });
</script>

</body>
</html>
    